# Integration test docker-compose for HarborBuddy
# This compose file tests HarborBuddy with various container scenarios

services:
  # HarborBuddy under test - runs once in dry-run mode
  harborbuddy:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: harborbuddy-test
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./test-logs:/logs
    environment:
      - TZ=America/Los_Angeles
      - HARBORBUDDY_SCHEDULE_TIME=03:00
      - HARBORBUDDY_DRY_RUN=true
      - HARBORBUDDY_LOG_LEVEL=debug
    labels:
      com.harborbuddy.autoupdate: "false"
      com.harborbuddy.test: "true"
    # Run once and exit
    command: [ "--once", "--dry-run", "--log-level", "debug" ]

  # Test container 1: Should be managed (no exclusion label)
  test-nginx:
    image: nginx:1.24
    container_name: test-nginx
    labels:
      com.harborbuddy.test: "true"
    command: [ "nginx", "-g", "daemon off;" ]

  # Test container 2: Should be excluded (has exclusion label)
  test-redis:
    image: redis:7.0
    container_name: test-redis
    labels:
      com.harborbuddy.autoupdate: "false"
      com.harborbuddy.test: "true"
    command: [ "redis-server", "--save", "", "--appendonly", "no" ]

  # Test container 3: Alpine with older version (should be managed)
  test-alpine:
    image: alpine:3.18
    container_name: test-alpine
    labels:
      com.harborbuddy.test: "true"
    command: [ "sleep", "3600" ]

  # Test container 4: Postgres with exclusion label
  test-postgres:
    image: postgres:15
    container_name: test-postgres
    environment:
      - POSTGRES_PASSWORD=testpass
      - POSTGRES_DB=testdb
    labels:
      com.harborbuddy.autoupdate: "false"
      com.harborbuddy.test: "true"
    tmpfs:
      - /var/lib/postgresql/data

  # Test container 5: Should be managed with custom config
  test-busybox:
    image: busybox:1.35
    container_name: test-busybox
    labels:
      com.harborbuddy.test: "true"
    command: [ "sleep", "3600" ]
